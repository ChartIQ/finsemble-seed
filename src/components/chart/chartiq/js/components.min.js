!function(t,e){"function"==typeof define&&define.amd?define(["componentUI"],e):"object"==typeof exports?module.exports=e(require("./componentUI")):e(t)}(this,function(t){var T=t.CIQ,e={prototype:Object.create(T.UI.BaseComponent)};e.prototype.activeAttributes=null,e.prototype.createdCallback=function(){T.UI.BaseComponent.createdCallback.apply(this),this.activeAttributes={}},e.prototype.attachedCallback=function(){if(!this.attached){this.isDialog=!0,T.UI.BaseComponent.attachedCallback.apply(this);var e=this;this.node.stxtap(function(t){e.tap(t)}),$("cq-ui-manager").each(function(){this.registerForResize(e),e.uiManager=this})}},e.prototype.detachedCallback=function(){var t=this;$("cq-ui-manager").each(function(){this.unregisterForResize(t)})},e.prototype.addActiveAttribute=function(t){this.activeAttributes[t]=!0},e.prototype.tap=function(t){this.uiManager.topMenu()!==this&&t.currentTarget.active||t.stopPropagation()},e.prototype.resize=function(){this.params&&this.params.x?this.stxContextMenu():this.center(),$(this.node).find("cq-scroll").each(function(){this.resize()})},e.prototype.stxContextMenu=function(){var t=this.node.parent();"BODY"==t[0].tagName&&(t=$(window));var e=t.guaranteedWidth(),a=t.guaranteedHeight(),i=this.node.outerWidth(),o=this.node.outerHeight(),n=this.params.x,s=this.params.y;e<n+i&&(n=e-i),a<s+o&&(s-=o),s<0&&(s=0),this.node.css({top:s+"px",left:n+"px"})},e.prototype.center=function(){var t=this.node.parent();"BODY"==t[0].tagName&&(t=$(window));var e=t.guaranteedWidth(),a=t.guaranteedHeight(),i=this.node.outerWidth(),o=this.node.outerHeight(),n=e/2-i/2,s=a/2-o/2;n<0&&(n=0),2*o<a&&a/3<s+o/2&&(s=a/3-o/2),s<0&&(s=0),this.node.css({top:s+"px",left:n+"px"})},e.prototype.open=function(t){this.uiManager.openMenu(this,t)},e.prototype.close=function(){this.uiManager.closeMenu(this)},e.prototype.hide=function(){if(!$(this).find(":invalid").length){for(var t in this.node.children().each(function(){"function"==typeof this.hide&&this.hide()}),this.active=!1,this.uiManager.overlay&&this.uiManager.overlay.removeAttrBetter("cq-active"),this.activeAttributes)this.node.removeAttrBetter(t);this.activeAttributes={},$(this).find("input").each(function(){this==document.activeElement&&this.blur()})}},e.prototype.show=function(e){(this.params=e)||(e=this.params={});var a=this;this.uiManager.overlay||e.bypassOverlay||(this.uiManager.overlay=$("<cq-dialog-overlay></cq-dialog-overlay>"),T.UI.getMyContext(this).node.append(this.uiManager.overlay)),setTimeout(function(){for(var t in a.uiManager.overlay&&!e.bypassOverlay&&a.uiManager.overlay.attrBetter("cq-active"),a.activeAttributes["cq-active"]=!0,a.activeAttributes)a.node.attrBetter(t);a.resize(),a.active=!0})},T.UI.Dialog=document.registerElement("cq-dialog",e);var a={prototype:Object.create(T.UI.DialogContentTag)};a.prototype.save=function(){var i=this.node.find("input").val();if(i){var o=!1,n=this.context.stx.exportLayout();$("cq-views").each(function(){for(var t,e=this.params.viewObj,a=0;a<e.views.length&&(t=e.views[a],i!=T.first(t));a++);a==e.views.length&&((t={})[i]={},e.views.push(t)),t[i]=n,delete t[i].candleWidth,this.renderMenu(),o||(o=!0,this.params.nameValueStore.set("stx-views",e.views))}),this.close()}},T.UI.ViewDialog=document.registerElement("cq-view-dialog",a);var i={prototype:Object.create(T.UI.BaseComponent)};i.prototype.top=function(){this.scrollTop=0,this.node.perfectScrollbar&&this.node.perfectScrollbar("update")},i.prototype.scrollToElement=function(t){var e=this.clientHeight,a=this.scrollTop,i=t.offsetTop+t.clientHeight;t.offsetTop>a&&i<e+a||(this.scrollTop=Math.max(i-e,0),this.node.perfectScrollbar&&this.node.perfectScrollbar("update"))},i.prototype.resize=function(){var t=this.node;if(!t.parents(".sharing").length&&void 0===t.attr("cq-no-resize")){void 0!==t.attr("cq-no-maximize")&&(this.noMaximize=!0);var a=t[0].getBoundingClientRect(),e=t.prop("reduceMenuHeight")||45,i=$(window).height();if(i){var o=i-a.top-e,n=t.parents(".stx-holder,.stx-subholder");n.length&&n.each(function(){var t=$(this),e=t[0].getBoundingClientRect().top+t.height();o=Math.min(o,e-a.top-5)});for(var s=t.nextAll(),r=0;r<s.length;r++){var c=$(s[r]);c.is(":visible")&&(o-=c.height())}this.noMaximize||t.css({height:o+"px"}),t.css({"max-height":o+"px"}),this.node.perfectScrollbar&&this.node.perfectScrollbar("update")}}},i.prototype.createdCallback=function(){T.UI.BaseComponent.createdCallback.apply(this);var t=this.node=$(this);t.perfectScrollbar&&t.perfectScrollbar({suppressScrollX:!0}),t.css({"overflow-y":"auto"})},i.prototype.attachedCallback=function(){if(!this.attached){T.UI.BaseComponent.attachedCallback.apply(this),this.uiManager=$("cq-ui-manager"),0<this.uiManager.length&&(this.uiManager=this.uiManager[0]),this.addClaim(this),this.addEventListener(T.wheelEvent,function(t){t.stopPropagation()});var t=this;T.addResizeListener(this,function(){t.resize()}),this.resize(),this.attached=!0}},i.prototype.keyStroke=function(t,e,a){var i=this.node;if(!i.is(":trulyvisible"))return!1;if("up"!=e&&"down"!=e&&"enter"!=e&&32!=e)return!1;var o=i.find("cq-item"),n=i.find("cq-item[cq-focused]");if(32==e||"enter"==e)return!(!n.length||!n[0].selectFC||(n[0].selectFC.call(n,a),0));if(!n.length)return $(o[0]).attr("cq-focused","true"),this.scrollToElement(o[0]),!0;o.removeAttr("cq-focused");for(var s=0;s<o.length&&o[s]!==n[0];s++);return"up"==e&&--s<0&&(s=0),"down"==e&&++s>=o.length&&(s=o.length-1),$(o[s]).attr("cq-focused","true"),this.scrollToElement(o[s]),!0},i.prototype.focused=function(){var t=this.node.find("cq-item[cq-focused]");return t.length?t[0]:null},T.UI.Scroll=document.registerElement("cq-scroll",i);var o={prototype:Object.create(T.UI.ModalTag)};o.prototype.attachedCallback=function(){this.attached||(T.UI.ModalTag.attachedCallback.apply(this),this.nameValueStore=new T.NameValueStore,this.attached=!0)},o.prototype.setSleepAmount=function(t,e){this.sleepAmount={units:t,unitType:e}},o.prototype.setNameValueStore=function(t){this.nameValueStore=t},o.prototype.makeMarker=function(){this.markerExists||(new T.Marker({stx:this.context.stx,xPositioner:"none",label:"advertisement",permanent:!0,node:this.node[0]}),this.markerExists=!0)},o.prototype.show=function(t,e){if(this.selector&&this.node.find(this.selector).removeClass("ciq-show"),this.selector=t,!this.selector){var a=this.node.find("div:first-of-type");this.selector="."+a.attr("class")}this.ignoreSleep=e;var i=this;function o(){i.makeMarker(),i.node.css({display:"block"}),i.node.find(i.selector).addClass("ciq-show"),i.node.css({height:"0px"}),setTimeout(function(){i.node.css({height:i.node[0].scrollHeight+"px"})},0)}e?o():this.nameValueStore.get("cq-advertisement",function(t,e){if(!t){e&&"object"==typeof e||(e={});var a=e[i.selector];a&&a>Date.now()||o()}})},o.prototype.close=function(){this.node.css({display:"none"});var s=this;this.nameValueStore.get("cq-advertisement",function(t,e){if(!t){var a=new Date;s.sleepAmount||(s.sleepAmount={units:1,unitType:"day"});var i=s.sleepAmount.units,o=s.sleepAmount.unitType;"minute"==o?a.setMinutes(a.getMinutes()+i):"hour"==o?a.setHours(a.getHours()+i):"day"==o?a.setDate(a.getDate()+i):"week"==o?a.setDate(a.getDate()+7*i):"month"==o&&a.setMonth(a.getMonth()+i);var n=a.getTime();e&&"object"==typeof e||(e={}),e[s.selector]=n,s.nameValueStore.set("cq-advertisement",e)}})},o.prototype.watchForRemoteClose=function(t){t||(t=1e3);var i=this;setInterval(function(){"none"!=i.node.css("display")&&i.nameValueStore.get("cq-advertisement",function(t,e){if(!t){e&&"object"==typeof e||(e={});var a=e[i.selector];a&&a>Date.now()&&i.close()}})},t)},T.UI.Advertisement=document.registerElement("cq-advertisement",o);var n={prototype:Object.create(T.UI.ModalTag)};n.prototype.insert=function(t,e){var a=T.UI.makeFromTemplate(this.template);return new T.Marker({stx:t,node:a[0],xPositioner:"none",yPositioner:"none",label:"attribution",panelName:e}),a},n.prototype.attachedCallback=function(){this.attached||(T.UI.ModalTag.attachedCallback.apply(this),this.attached=!0)},n.prototype.setContext=function(t){this.template=this.node.find("template");var s=this.insert(t.stx,"chart"),r=this;this.addInjection("append","createDataSet",function(){var t,e;this.chart.attribution&&((t=r.messages.sources[this.chart.attribution.source])||(t=""),(e=r.messages.exchanges[this.chart.attribution.exchange])||(e=""),t+e!=s.attr("lastAttrib")&&(s.find("cq-attrib-source").html(t),s.find("cq-attrib-quote-type").html(e),T.I18N.translateUI(null,s[0]),s.attr("lastAttrib",t+e)));t:for(var a in this.layout.studies){var i=this.layout.studies[a].type;if(r.messages.sources[i]){for(var o=0;o<this.markers.attribution.length;o++)if(this.markers.attribution[o].params.panelName==this.layout.studies[a].panel)continue t;if(!this.panels[a])continue;(t=r.messages.sources[i])||(t=""),(e=r.messages.exchanges[i])||(e="");var n=r.insert(this,a);n.find("cq-attrib-source").html(t),n.find("cq-attrib-quote-type").html(e),T.I18N.translateUI(null,n[0])}}})},n.prototype.messages={sources:{simulator:"Simulated data.",demo:"Demo data.",xignite:'<a target="_blank" href="https://www.xignite.com">Market Data</a> by Xignite.',Twiggs:'Formula courtesy <a target="_blank" href="https://www.incrediblecharts.com/indicators/twiggs_money_flow.php">IncredibleCharts</a>.'},exchanges:{RANDOM:"Data is randomized.","REAL-TIME":"Data is real-time.",DELAYED:"Data delayed 15 min.",BATS:"BATS BZX real-time.",EOD:"End of day data."}},T.UI.Attribution=document.registerElement("cq-attribution",n);var s={prototype:Object.create(T.UI.ModalTag)};s.prototype.attachedCallback=function(){this.attached||(T.UI.ModalTag.attachedCallback.apply(this),this.attached=!0)},s.prototype.setContext=function(t){var e=this;T.UI.observe({obj:e.context.stx.chart,member:"symbolObject",action:"callback",value:function(){e.context.stx.currentQuote()&&(e.previousClose=e.context.stx.currentQuote().iqPrevClose)}}),this.initialize()},s.prototype.begin=function(){var t=this;this.addInjection("append","createDataSet",function(){t.update()}),this.update()},s.prototype.initialize=function(t){this.params=t||{},void 0===this.params.autoStart&&(this.params.autoStart=!0),this.marker=null,this.params.autoStart&&this.begin()},s.prototype.previousClose=null,s.prototype.update=function(){var t=this.context.stx,e=$(this);t.chart.dataSet&&t.chart.dataSet.length?e.addClass("stx-show"):e.removeClass("stx-show");var a=e.find("cq-symbol"),i=e.find("cq-symbol-description"),o=e.find("cq-current-price"),n=e.find("cq-todays-change"),s=e.find("cq-todays-change-pct"),r=e.find("cq-chart-price"),c=e.find("cq-change"),l=this.node.truthyAttr("cq-browser-tab"),p=r.length,h=t.chart.symbol,u=t.chart.symbolDisplay,d=t.internationalizer,m=!1;a.textBetter(h);var f,v="",g=0,y="",b=t.currentQuote();if((f=b?b.Close:"")&&p){var x=parseFloat(o.text());o.textBetter(t.formatYAxisPrice(f,t.chart.panel))&&(m=!0,void 0!==o.attr("cq-animate")&&T.UI.animatePrice(o,f,x))}if(i.textBetter(u||h),(p||l)&&h&&m){var C=this.previousClose?this.previousClose:b?b.iqPrevClose:null;b&&C?(g=(v=T.fixPrice(b.Close-C))/C*100,y=d?d.percent2.format(g/100):g.toFixed(2)+"%",c.css({display:"block"})):c.css({display:"none"});var q=Math.abs(v);q&&n.textBetter(t.formatYAxisPrice(q,t.chart.panel)),s.textBetter(y),""!==y&&0<g?r.removeClass("stx-down").addClass("stx-up"):""!==y&&g<0?r.removeClass("stx-up").addClass("stx-down"):r.removeClass("stx-down").removeClass("stx-up"),this.title=h+" \u200b \u200b "+f+" \u200b \u200b \u200b ",0<g?this.title+="\u25b2 "+q:g<0&&(this.title+="\u25bc "+q),l&&(document.title=this.title)}},T.UI.ChartTitle=document.registerElement("cq-chart-title",s);var r={prototype:Object.create(T.UI.ContextTag)};r.prototype.createdCallback=function(){T.UI.ContextTag.createdCallback.apply(this)},r.prototype.attachedCallback=function(){if(!this.attached){T.UI.ContextTag.attachedCallback.apply(this),this.attached=!0;var t=this;$(this).stxtap(function(){t.runMethod()})}},r.prototype.runMethod=function(){var t=this.node.attr("cq-selector"),e=this.node.attr("cq-method"),a=this;$(t).each(function(){this[e]&&this[e].call(this,{context:a.context,caller:a})})},T.UI.Clickable=document.registerElement("cq-clickable",r);var c={prototype:Object.create(T.UI.BaseComponent)};c.prototype.attachedCallback=function(){if(!this.attached){var t=this;$(this).stxtap(function(){t.tap()}),T.UI.BaseComponent.attachedCallback.apply(this),this.attached=!0}},c.prototype.tap=function(){T.UI.containerExecute(this,"close")},T.UI.Close=document.registerElement("cq-close",c);var l={prototype:Object.create(T.UI.ModalTag)};l.prototype.attachedCallback=function(){this.attached||(T.UI.ModalTag.attachedCallback.apply(this),this.attached=!0,this.swatchColors=["#8ec648","#00afed","#ee652e","#912a8e","#fff126","#e9088c","#ea1d2c","#00a553","#00a99c","#0056a4","#f4932f","#0073ba","#66308f","#323390"],this.loading=[])},l.prototype.removeSeries=function(t,e){this.context.stx.removeSeries(t)},l.prototype.pickSwatchColor=function(){var t=$(this),e=this.context.stx,a=t.find("cq-swatch");if(a.length){var i=a[0].style.backgroundColor,o={};for(var n in e.chart.series){var s=e.chart.series[n];s.parameters.isComparison&&(o[s.parameters.color]=!0)}if(""===i||o[i])for(var r=0;r<this.swatchColors.length;r++)if(!o[this.swatchColors[r]])return void(a[0].style.backgroundColor=this.swatchColors[r])}},l.prototype.renderLegend=function(){var t=$(this).find("cq-comparison-key").cqvirtual(),e=this.context.stx,a=e.currentQuote();for(var i in e.chart.series){var o=e.chart.series[i];if(o.parameters.isComparison){var n=T.UI.makeFromTemplate(this.template),s=n.find("cq-comparison-swatch"),r=n.find("cq-comparison-label"),c=n.find("cq-comparison-description"),l=n.find("cq-comparison-price"),p=n.find("cq-comparison-loader"),h=n.find(".ciq-close");s.css({"background-color":o.parameters.color}),r.text(e.translateIf(o.display)),c.text(e.translateIf(o.description)),n.attr("cq-symbol",i);var u=o.parameters.symbol;l.length&&a&&l.text(e.padOutPrice(a[u])),this.loading[o.parameters.symbolObject.symbol]?p.addClass("stx-show"):p.removeClass("stx-show"),o.parameters.error&&n.attr("cq-error",!0),o.parameters.permanent?h.hide():h.stxtap(function(t,e,a){return function(){t.nomore=!0,t.removeSeries(e,a),t.modalEnd()}}(this,i,o)),t.append(n)}}t.cqrender(),this.pickSwatchColor()},l.prototype.updatePrices=function(){var t,e=this.context.stx,a=e.currentQuote();if(a)for(var i in e.chart.series){t||(t=this.node.find("cq-comparison-key"));var o=t.find('cq-comparison-item[cq-symbol="'+i+'"] cq-comparison-price');if(o.length){var n=parseFloat(o.text()),s=a[e.chart.series[i].parameters.symbol];s&&(s.Close||0===s.Close)&&(s=s.Close),!s&&0!==s&&e.chart.series[i].lastQuote&&(s=e.chart.series[i].lastQuote.Close),o.text(e.padOutPrice(s)),void 0!==o.attr("cq-animate")&&T.UI.animatePrice(o,s,n)}}},l.prototype.startPriceTracker=function(t){var e=this;this.addInjection("append","createDataSet",function(){t&&e.updatePrices(),this.chart.dataSet&&this.chart.dataSet.length?e.node.attrBetter("cq-show"):e.node.removeAttrBetter("cq-show")})},l.prototype.position=function(){var o=this.context.stx,t=o.barFromPixel(o.cx);this.tick=o.tickFromPixel(o.cx);var n=o.chart.xaxis[t],s=this;this.tick!=this.prevTick&&(this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(function(){var t;for(var e in s.timeout=null,o.chart.series){t||(t=s.node.find("cq-comparison-key"));var a=t.find('cq-comparison-item[cq-symbol="'+e+'"] cq-comparison-tick-price');if(a.textBetter(""),a.length&&n&&n.data){var i=o.chart.series[e].parameters.symbol;a.textBetter(o.padOutPrice(n.data[i]))}}},0)),this.prevTick=this.tick},l.prototype.startTickPriceTracker=function(){var t;this.prevTick=null,this.addInjection("prepend","headsUpHR",(t=this,function(){t.position()}))},l.prototype.setContext=function(t){var e=this.context.stx.chart;this.node.attr("cq-show","true"),this.configureUI();var a=this;T.UI.observe({obj:e.series,action:"callback",value:function(){a.renderLegend()}});var i=T.UI.makeFromTemplate(this.template);this.startPriceTracker(i.find("cq-comparison-price").length),i.find("cq-comparison-tick-price")&&this.startTickPriceTracker()},l.prototype.selectItem=function(t,e){var a=this,i=this.node.find("cq-swatch"),o="auto",n=null,s=1;if(i[0]){var r=i[0].style;o=r.backgroundColor,n=r.borderTopStyle,s=r.width||1}for(var c=t.stx,l={name:"_generic_series",symbolObject:e,isComparison:this.loading[e.symbol]=!0,color:o,pattern:n,width:s||1,data:{useDefaultQuoteFeed:!0},forceData:!0},p=c.getSeries({symbolObject:e}),h=0;h<p.length;h++)if(p[h].parameters.isComparison)return;t.stx.chart.symbol.toLowerCase()!==e.symbol.toLowerCase()&&0<e.symbol.trim().length&&c.addSeries(e.symbol,l,function(t,e){t&&(e.parameters.error=!0),a.loading[e.parameters.symbolObject.symbol]=!1,a.renderLegend()})},l.prototype.configureUI=function(){var t=this.node,e=t.find("cq-accept-btn");this.template=t.find("*[cq-comparison-item]");var a=t.find("cq-swatch").attr("cq-colors");a&&(this.swatchColors=a.split(","));for(var i=0;i<this.swatchColors.length;i++)this.swatchColors[i]=T.convertToNativeColor(this.swatchColors[i]);var o,n=t.find("cq-lookup");n.length&&n[0].setCallback((o=this,function(){o.selectItem.apply(o,arguments)})),e.stxtap(function(t){n[0].forceInput(),t.stopPropagation()}),t.find("input").stxtap(function(){this.focus()})},T.UI.Comparison=document.registerElement("cq-comparison",l);var p={prototype:Object.create(T.UI.DialogContentTag)};p.prototype.add=function(){var t=$(this).find("[cq-custom-fibonacci-setting] input").val();if(t&&(t=parseFloat(t)/100,!isNaN(t))){var e,a,i=this.context.stx.currentVectorParameters.fibonacci.fibs||{};for(var o in i)if((e=i[o]).level>t){(a=T.clone(e)).level=t,a.display=!0,i.splice(o,0,a);break}a||(e=i.length?T.clone(i[0]):{color:"auto",parameters:{pattern:"solid",opacity:.25,lineWidth:1}},(a=T.clone(e)).level=t,a.display=!0,i.push(a)),this.open()}},p.prototype.setChangeEvent=function(t,e,n){var s=this;t.change(function(){var t=s.context.stx.currentVectorParameters,e=t.vectorType;if(t.fibonacci&&"fibtimezone"!=e){var a=t.fibonacci.fibs||{};if("checkbox"==this.type)for(var i in a){var o=a[i];o.level===n&&(o.display=!!this.checked)}}})},p.prototype.open=function(t){T.UI.DialogContentTag.open.apply(this,arguments);var e,a=this.context.stx.currentVectorParameters,i=a.vectorType,o=$(this);if(a.fibonacci&&"fibtimezone"!=i){o.find(".title").text("Fibonacci Settings");var n=a.fibonacci.fibs||{};for(var s in(e=o.find("cq-fibonacci-settings")).emptyExceptTemplate(),n){var r=n[s];if(!("fibarc"===i&&r.level<0)){var c=T.UI.makeFromTemplate(this.node.find("template"),e),l=100*r.level;c.find(".ciq-heading").text(l.toFixed(1)+"%");var p=c.find("input");r.display&&p.prop("checked",!0),this.setChangeEvent(p,"fib",r.level),c.find(".stx-data").append(p)}}}else o.find(".title").text("Settings"),(e=o.find("cq-fibonacci-settings")).emptyExceptTemplate();$(this).find("[cq-custom-fibonacci-setting] input").val("")},T.UI.FibSettingsDialog=document.registerElement("cq-fib-settings-dialog",p);var h={prototype:Object.create(T.UI.DialogContentTag)};h.prototype.open=function(t){T.UI.DialogContentTag.open.apply(this,arguments);var e=this.node.find("cq-languages");e.emptyExceptTemplate();var a=this.node.find("template"),i=T.I18N.languages;if(i)for(var o in i){var n=T.UI.makeFromTemplate(a,e);n.find("cq-language-name").text(i[o]),n.find("cq-flag").attr("cq-lang",o),n.stxtap(s(o))}function s(e){return function(){T.UI.contextsForEach(function(){var t=this.stx;t.preferences.language=e,t.changeOccurred("preferences"),T.I18N.localize(t,e),t.draw()})}}},h.prototype.close=function(){$("cq-language-dialog").closest("cq-dialog,cq-menu").each(function(){this.close()})},T.UI.LanguageDialog=document.registerElement("cq-language-dialog",h);var u={prototype:Object.create(T.UI.ContextTag)};u.prototype.setContext=function(t){this.context.setLoader(this)},u.prototype.show=function(){$(this).addClass("stx-show")},u.prototype.hide=function(){$(this).removeClass("stx-show")},T.UI.Loader=document.registerElement("cq-loader",u);var d={prototype:Object.create(T.UI.ContextTag)};d.prototype.attachedCallback=function(){this.attached||(this.usingEmptyDriver=!1,T.UI.ContextTag.attachedCallback.apply(this),this.attached=!0,this.currentFilter=null,this.params={})},d.prototype.setContext=function(t){this.initialize()},d.prototype.attachDriver=function(t){this.driver=t},d.prototype.setCallback=function(t){this.params.cb=t},d.prototype.setDriver=function(t){this.params.driver=t},d.prototype.initialize=function(){var t=$(this);this.resultList=t.find("cq-scroll"),this.input=t.find("input"),this.input.length||(this.input=t.append($("<input type='hidden'>")),this.input[0].value="");var a=this;this.input.on("paste",function(t){var e=t.target;setTimeout(function(){a.acceptText(e.value,a.currentFilter)},0)});var i=t.find("cq-lookup-filters");i&&i.find("cq-filter").stxtap(function(){i.find("cq-filter").removeClass("true");var t=$(this);t.addClass("true");var e=t.find("translate");e.length?a.currentFilter=e.attr("original"):a.currentFilter=this.innerHTML,a.acceptText(a.input[0].value,a.currentFilter)}),void 0!==t.attr("cq-keystroke-claim")&&this.addClaim(this)},d.prototype.selectItem=function(t,e){this.params.cb&&this.params.cb(this.context,t,e)},d.prototype.open=function(){this.node.closest("cq-dialog,cq-menu").each(function(){this.open()})},d.prototype.close=function(){this.node.closest("cq-dialog,cq-menu").each(function(){this.close()})},d.prototype.isActive=function(){return""!==this.input[0].value},d.prototype.acceptText=function(t,e){var a=this;this.params.driver||(this.context.lookupDriver?this.setDriver(this.context.lookupDriver):(this.setDriver(new T.UI.Lookup.Driver),this.usingEmptyDriver=!0)),this.params.driver.acceptText(t,e,null,function(t){a.results(t)})},d.prototype.forceInput=function(){var t=this.input[0];this.selectItem({symbol:t.value}),T.blur(this.input),this.close(),t.value=""},d.prototype.keyStroke=function(t,e,a,i){if(i.ctrl||91==e)return!1;var o=$(this).parents().addBack(),n=this.input[0],s=!1,r=document.activeElement===n;if(!r&&document.activeElement&&("INPUT"==document.activeElement.tagName||"TEXTAREA"==document.activeElement.tagName))return!1;var c=!1,l=!1;if(o.hasClass("stxMenuActive")&&(l=!0),(r||l)&&(c=!0),!c){if(void 0===this.node.attr("cq-keystroke-default"))return;if(!l&&this.uiManager.topMenu())return}if(32===e&&""===n.value)return!1;if(32<=e&&e<=222&&(r||(n.value=n.value+String.fromCharCode(e)),this.acceptText(n.value,this.currentFilter),s=!0),"delete"==e||"backspace"==e){if(this.context.stx.anyHighlighted)return!1;n.value.length&&(window.getSelection().toString()?n.value="":(r||(n.value=n.value.substring(0,n.value.length-1)),n.value.length&&this.acceptText(n.value,this.currentFilter)),s=!0),"backspace"==e&&(s=!0)}if("escape"===e&&l&&(n.value="",this.close(),T.blur(n),s=!0),"enter"===e&&""!==n.value&&this.isActive()){var p=this.node.find("cq-scroll");if((r=p.length&&p[0].focused())&&r.selectFC)r.selectFC.apply(r,{});else{var h=n.value;this.node.truthyAttr("cq-uppercase")&&(h=h.toUpperCase()),this.selectItem({symbol:h})}T.blur(this.input),this.close(),s=!(n.value="")}return s?(!this.usingEmptyDriver&&(n.value.length||"escape"!=e&&"enter"!=e&&r)?this.open():this.close(),!r||{allowDefault:!0}):void 0},d.prototype.results=function(t){function e(e,a){return function(t){T.blur(e.input),e.selectItem(a),e.input[0].value=""}}this.resultList.empty();for(var a=0;a<t.length;a++){for(var i=t[a],o="<cq-item>",n=0;n<i.display.length;n++)o+="<SPAN>"+i.display[n]+"</SPAN>";o+="</cq-item>";var s=$(o);this.resultList.append(s),s[0].selectFC=e(this,i.data),s.stxtap(s[0].selectFC)}var r=this.node.find("cq-scroll");r.length&&r[0].top()},T.UI.SymbolLookup=document.registerElement("cq-lookup",d);var m={prototype:Object.create(T.UI.ContextTag)};m.prototype.createdCallback=function(){T.UI.ContextTag.createdCallback.apply(this),this.redoButton=null,this.undostack=[],this.redostack=[],this.contexts=[]},m.prototype.attachedCallback=function(){if(!this.attached){T.UI.ContextTag.attachedCallback.apply(this),this.attached=!0;var t=this;$(this).stxtap(function(){t.undo()})}},m.prototype.setContext=function(t){this.manageContext(this.context);var e=this;this.addInjection("append","initializeChart",function(){e.undostack=[],e.redostack=[],e.clear()})},m.prototype.handleEvent=function(t,e,a){this.undostack.push({context:t,drawings:a.before}),this.redostack=[],this.setButtonStyle()},m.prototype.manageContext=function(e){this.addClaim(this);var a=this;e.stx.addEventListener("undoStamp",function(t){a.handleEvent(e,"undoStamp",t)}),this.contexts.push(e)},m.prototype.keyStroke=function(t,e,a,i){return 90==e&&(i.ctrl||i.cmd)?(i.shift?this.redo():this.undo(),!0):89==e&&(i.ctrl||i.cmd)?(this.redo(),!0):void 0},m.prototype.undo=function(){for(var t=!1,e=0;e<this.contexts.length;e++)this.contexts[e].stx.activeDrawing&&(this.contexts[e].stx.undo(),t=!0);if(!t){var a=this.undostack.pop();if(a){var i=a.context;this.redostack.push({context:i,drawings:T.shallowClone(i.stx.drawingObjects)});var o=a.drawings;i.stx.drawingObjects=T.shallowClone(o),i.stx.changeOccurred("vector"),i.stx.draw()}this.setButtonStyle()}},m.prototype.redo=function(){var t=this.redostack.pop();if(t){var e=t.context;this.undostack.push({context:e,drawings:T.shallowClone(e.stx.drawingObjects)});var a=t.drawings;e.stx.drawingObjects=T.shallowClone(a),e.stx.changeOccurred("vector"),e.stx.draw()}this.setButtonStyle()},m.prototype.clear=function(t){this.setButtonStyle()},m.prototype.setButtonStyle=function(){this.undostack.length?$(this).attr("cq-active","true"):$(this).removeAttr("cq-active"),this.redoButton&&(this.redostack.length?$(this.redoButton).attr("cq-active","true"):$(this.redoButton).removeAttr("cq-active"))},T.UI.Undo=document.registerElement("cq-undo",m);var f={prototype:Object.create(T.UI.ContextTag)};f.prototype.attachedCallback=function(){this.attached||(T.UI.ContextTag.attachedCallback.apply(this),this.attached=!0)},f.prototype.pairUp=function(t){this.undo=$(t)[0];var e=this.undo.redoButton=this;$(this).stxtap(function(){e.undo.redo()})},T.UI.Redo=document.registerElement("cq-redo",f);var v={prototype:Object.create(T.UI.ContextTag)};v.prototype.set=function(t,e,a,i,o,n){var s=this;s.context.loader&&s.context.loader.show();var r={multiplier:e,base:a};i&&(r.periodicity={interval:i,period:o||1,timeUnit:n}),s.context.stx.setSpan(r,function(){s.context.loader&&s.context.loader.hide()})},T.UI.ShowRange=document.registerElement("cq-show-range",v);var g={prototype:Object.create(T.UI.ContextTag)};g.prototype.createdCallback=function(){T.UI.ContextTag.createdCallback.apply(this,arguments),this.callbacks=[]},g.prototype.registerCallback=function(t){this.callbacks.push(t)},g.prototype.open=function(t){this.close();var e=this.node.find(t.selector);t.className?(e.addClass(t.className),e.each(function(){this.sidePanelActiveClass=t.className})):(e.attr(t.attribute,"true"),e.each(function(){this.sidePanelActiveAttribute=t.attribute})),this.node.attr("cq-active","true");var a=this;setTimeout(function(){a.resizeMyself()},0)},g.prototype.close=function(){this.node.removeAttr("cq-active"),this.node.children().each(function(){this.sidePanelActiveClass?$(this).removeClass(this.sidePanelActiveClass):$(this).removeAttr(this.sidePanelActiveAttribute)});var t=this;setTimeout(function(){t.resizeMyself()},0)},g.prototype.nonAnimatedWidth=function(){var a=0;return this.node.children().width(function(t,e){a+=e}),a},g.prototype.resizeMyself=function(){var a=0;this.node.children().width(function(t,e){a+=e}),this.node.css({width:a+"px"});for(var t=0;t<this.callbacks.length;t++)this.callbacks[t].call(this,a)},T.UI.SidePanel=document.registerElement("cq-side-panel",g);var y={prototype:Object.create(T.UI.DialogContentTag)};T.UI.StudyContext=document.registerElement("cq-study-context",y);var b={prototype:Object.create(HTMLElement.prototype)};b.prototype.defaultColor=null,b.prototype.attachedCallback=function(){var e;this.attached||(this.node=$(this),this.node.stxtap((e=this,function(t){e.launchColorPicker(),t.stopPropagation()})),this.attached=!0)},b.prototype.getDefaultColor=function(){if(this.defaultColor)return this.defaultColor;var t=T.UI.getMyContext(this);return t?t.stx.defaultColor:"trasparent"},b.prototype.setColor=function(t,e){var a=$(this),i=T.getBackgroundColor(this.parentNode),o=T.hsl(i);t||(t="transparent");var n=t;"auto"==t&&(n=this.getDefaultColor());var s=T.hsl(n);if(Math.abs(o[2]-s[2])<.2||T.isTransparent(t)){var r=T.chooseForegroundColor(i);a.css({border:"solid "+r+" 1px"})}else a.css({border:""});a.css({"background-color":n}),!1!==e&&T.UI.containerExecute(this,"setColor",t)},b.prototype.launchColorPicker=function(){var e,t=$(this),a=$("cq-color-picker")[0];a.callback=(e=this,function(t){e.setColor(t,null)});var i=this.node.attr("cq-overrides");i&&(i=i.split(",")),a.display({node:t,overrides:i}),this.colorPicker=a},T.UI.Swatch=document.registerElement("cq-swatch",b);var x={prototype:Object.create(T.UI.ContextTag)};x.prototype.attachedCallback=function(){this.attached||(T.UI.ContextTag.attachedCallback.apply(this),this.attached=!0)},x.prototype.setContext=function(t){this.initialize()},x.prototype.start=function(){$(".stx-trade-panel").appendTo($("cq-side-panel"));var t=this.context.stx;t.account=new T.Account.Demo;var e={stx:t,account:t.account};t.tfc=new T.TFC(e);var a=this;$(".stx-trade-nav .stx-trade-ticket-toggle").stxtap(function(){$(".stx-trade-nav").removeClass("active"),$(".stx-trade-info").addClass("active"),$("cq-side-panel")[0].resizeMyself()}),$(".stx-trade-info .stx-trade-ticket-toggle").stxtap(function(){$(".stx-trade-nav").addClass("active"),$(".stx-trade-info").removeClass("active"),$("cq-side-panel")[0].resizeMyself()}),t.tfc.selectSymbol=function(t){t=t.toUpperCase(),a.context.changeSymbol({symbol:t})}},x.prototype.initialize=function(){var e=this;T.loadWidget("plugins/tfc/tfc",function(t){t?console.log(t):T.loadScript("plugins/tfc/tfc-demo.js",e.start.bind(e))})},T.UI.TFC=document.registerElement("cq-tfc",x);var C={prototype:Object.create(T.UI.DialogContentTag)};C.prototype.applyChanges=function(){var t=this.context.stx;this.helper.update(t),t.changeOccurred("theme")},C.prototype.setValue=function(t,e,a){t[e]=a,this.applyChanges()},C.prototype.close=function(){this.helper.settings=this.revert,this.applyChanges(),T.UI.DialogContentTag.close.apply(this)},C.prototype.save=function(){var t=this.node.find("cq-action input").val(),e={settings:T.clone(this.helper.settings),name:t,builtIn:null};T.UI.contextsForEach(function(){this.stx.updateListeners("theme")});var a=this;$("cq-themes").each(function(){e.builtIn=this.currentLoadedBuiltIn,this.addCustom(e,a.initiatingMenu)}),T.UI.DialogContentTag.close.apply(this)},C.prototype.open=function(t){T.UI.DialogContentTag.open.apply(this,arguments);var e=t.themeName;this.initiatingMenu=t.initiatingMenu,this.context=t.context,this.helper=new T.ThemeHelper({stx:this.context.stx}),this.revert=T.clone(this.helper.settings);var n=this;function a(t,e,a,i){var o=n.node.find('cq-theme-piece[cq-piece="'+t+'"]');o[0].piece={obj:e,field:a},"color"==i&&o.find("cq-swatch")[0].setColor(e[a],!1)}var i=this.helper.settings;a("cu",i.chartTypes["Candle/Bar"].up,"color","color"),a("cd",i.chartTypes["Candle/Bar"].down,"color","color"),a("wu",i.chartTypes["Candle/Bar"].up,"wick","color"),a("wd",i.chartTypes["Candle/Bar"].down,"wick","color"),a("bu",i.chartTypes["Candle/Bar"].up,"border","color"),a("bd",i.chartTypes["Candle/Bar"].down,"border","color"),a("lc",i.chartTypes.Line,"color","color"),a("mc",i.chartTypes.Mountain,"color","color"),a("bg",i.chart.Background,"color","color"),a("gl",i.chart["Grid Lines"],"color","color"),a("dd",i.chart["Grid Dividers"],"color","color"),a("at",i.chart["Axis Text"],"color","color"),e||(e="My Theme"),this.node.find("cq-action input").val(e)},T.UI.ThemeDialog=document.registerElement("cq-theme-dialog",C);var q={prototype:Object.create(T.UI.BaseComponent)};q.prototype.setColor=function(t){"Hollow"!=t&&"No Border"!=t||(t="transparent",this.node.find("cq-swatch")[0].setColor("transparent",!1)),T.UI.containerExecute(this,"setValue",this.piece.obj,this.piece.field,t)},q.prototype.setBoolean=function(t){T.UI.containerExecute(this,"setValue",this.piece.obj,this.piece.field,t)},T.UI.ThemePiece=document.registerElement("cq-theme-piece",q);var k={prototype:Object.create(T.UI.ContextTag)};k.prototype.attachedCallback=function(){this.attached||(T.UI.ContextTag.attachedCallback.apply(this),this.attached=!0,this.builtInMenu=$(this).find("cq-themes-builtin"),this.builtInTemplate=this.builtInMenu.find("template"),this.customMenu=$(this).find("cq-themes-custom"),this.customTemplate=this.customMenu.find("template"))},k.prototype.initialize=function(t){this.params={},t&&(this.params=t),this.params.customThemes||(this.params.customThemes={}),this.params.builtInThemes||(this.params.builtInThemes={}),this.params.nameValueStore||(this.params.nameValueStore=new T.NameValueStore),this.id=t.id?t.id+"-":"";var a=this;this.params.nameValueStore?this.params.nameValueStore.get("CIQ.Themes.prototype.custom",function(t,e){!t&&e&&(a.params.customThemes=e),a.params.nameValueStore.get(a.id+"CIQ.Themes.prototype.current",function(t,e){!t&&e&&e.theme?a.loadTheme(e.theme):a.loadTheme(a.params.defaultTheme),a.configureMenu()})}):this.loadTheme(a.params.defaultTheme)},k.prototype.configureMenu=function(){function t(e,a){return function(t){e.loadBuiltIn(a),e.params.callback&&e.params.callback({theme:e.currentTheme}),e.persist("current")}}function e(e,a){return function(t){e.loadCustom(a),e.params.callback&&e.params.callback({theme:e.currentTheme}),e.persist("current")}}var a,i;this.builtInMenu.emptyExceptTemplate(),this.customMenu.emptyExceptTemplate();var o=this.params.builtInThemes;for(var n in o)a=o[n],(i=T.UI.makeFromTemplate(this.builtInTemplate)).text(a),i[0].selectFC=t(this,n),i.stxtap(i[0].selectFC),this.builtInMenu.append(i);var s=this.params.customThemes;for(var r in s)a=r,(i=T.UI.makeFromTemplate(this.customTemplate)).find("cq-label").text(a),i[0].selectFC=e(this,r),i.stxtap(i[0].selectFC),i[0].close=function(t,e){return function(){t.removeTheme(e)}}(this,r),this.customMenu.append(i)},k.prototype.removeTheme=function(t){var e=!1;$("cq-themes").each(function(){delete this.params.customThemes[t],this.configureMenu(),e||(this.persist(),e=!0)})},k.prototype.persist=function(t){this.params.nameValueStore&&(t&&"current"!=t||this.params.nameValueStore.set(this.id+"CIQ.Themes.prototype.current",{theme:this.currentTheme}),t&&"custom"!=t||this.params.nameValueStore.set("CIQ.Themes.prototype.custom",this.params.customThemes))},k.prototype.addCustom=function(t,e){this.params.customThemes[t.name]=t,e===this&&(this.currentTheme=t.name),this.configureMenu(),this.persist()},k.prototype.reinitializeChart=function(t){var e=this.context.stx;if(e.styles={},e.chart.container.style.backgroundColor="",t){var a=new T.ThemeHelper({stx:e});a.settings=t.settings,a.update()}e.updateListeners("theme"),e.changeOccurred("theme"),e.displayInitialized&&(e.headsUpHR(),e.clearPixelCache(),e.updateListeners("theme"),e.draw())},k.prototype.loadTheme=function(t){this.params.customThemes[t]?this.loadCustom(t):this.params.builtInThemes[t]?this.loadBuiltIn(t):this.loadBuiltIn(this.params.defaultTheme)},k.prototype.loadBuiltIn=function(t){this.currentLoadedBuiltIn&&$(this.context.topNode).removeClass(this.currentLoadedBuiltIn),$(this.context.topNode).addClass(t),this.currentLoadedBuiltIn=this.currentTheme=t,this.reinitializeChart()},k.prototype.loadCustom=function(t){this.currentLoadedBuiltIn&&$(this.context.topNode).removeClass(this.currentLoadedBuiltIn);var e=this.params.customThemes[t];e.builtIn&&$(this.context.topNode).addClass(e.builtIn),this.currentLoadedBuiltIn=e.builtIn,this.currentTheme=e.name,this.reinitializeChart(e)},k.prototype.newTheme=function(){var t=this;$("cq-theme-dialog").each(function(){this.open({context:t.context,initiatingMenu:t})})},T.UI.Themes=document.registerElement("cq-themes",k);var I={prototype:Object.create(T.UI.DialogContentTag)};I.prototype.removeTimezone=function(){T.ChartEngine.defaultDisplayTimeZone=null;var t=this.context.stx;t.displayZone=null,t.setTimeZone(),t.displayInitialized&&t.draw(),T.UI.DialogContentTag.close.apply(this)},I.prototype.open=function(t){T.UI.DialogContentTag.open.apply(this,arguments);var e=this.node,i=this;this.context=t.context;var o=this.context.stx,a=e.find("ul"),n=e.find(".ciq-btn");for(var s in this.template||(this.template=a.find("li#timezoneTemplate")[0].cloneNode(!0)),a.empty(),T.timeZoneMap){var r=s,c=o.translateIf(r),l=this.template.cloneNode(!0);l.style.display="block",l.innerHTML=c,T.safeClickTouch(l,d(r)),a.append(l)}var p=e.find("#currentUserTimeZone");if(o.displayZone){var h=o.displayZone;for(var u in T.timeZoneMap)T.timeZoneMap[u]===o.displayZone&&(h=u);p.text(o.translateIf("Current TimeZone is")+" "+h),n.show()}else p.text(o.translateIf("Your timezone is your current location")),n.hide();function d(a){return function(t){T.UI.DialogContentTag.close.apply(i);var e=T.timeZoneMap[a];T.ChartEngine.defaultDisplayTimeZone=e,o.setTimeZone(o.dataZone,e),o.chart.symbol&&o.draw()}}},T.UI.TimezoneDialog=document.registerElement("cq-timezone-dialog",I);var w={prototype:Object.create(T.UI.ContextTag)};w.prototype.setContext=function(t){this.currentValue=!1,this.params.obj=this.context.stx.layout;var e=this.node.attr("cq-member");e&&(this.params.member=e);var a=this.node.attr("cq-action");a&&(this.params.action=a);var i=this.node.attr("cq-value");i&&(this.params.value=i);var o=this.node.attr("cq-toggles");o&&(this.params.toggles=o.split(","));for(var n=0;n<this.params.toggles.length;n++)"null"==this.params.toggles[n]&&(this.params.toggles[n]=null);this.begin()},w.prototype.attachedCallback=function(){this.attached||(this.params={member:null,obj:null,action:"class",value:"active",toggles:[],callbacks:[]},T.UI.ContextTag.attachedCallback.apply(this),this.attached=!0)},w.prototype.registerCallback=function(t,e){!1!==e&&(e=!0),this.params.callbacks.push(t),e&&t.call(this,this.currentValue)},w.prototype.updateFromBinding=function(t){if(this.currentValue=t.obj[t.member],this.params.callbacks.length)for(var e=0;e<this.params.callbacks.length;e++)this.params.callbacks[e].call(this,this.currentValue);else"class"==this.params.action&&(this.currentValue?this.node.addClass(this.params.value):this.node.removeClass(this.params.value));"crosshair"==t.member&&!1===this.currentValue&&this.context.stx.doDisplayCrosshairs()},w.prototype.set=function(t){if(this.params.member)this.params.obj[this.params.member]=t;else{this.currentValue=t;for(var e=0;e<this.params.callbacks.length;e++)this.params.callbacks[e].call(this,this.currentValue)}},w.prototype.begin=function(){var o=this,n=this.context.stx;this.params.member&&T.UI.observe({selector:this.node,obj:this.params.obj,member:this.params.member,action:"callback",value:function(t){o.updateFromBinding(t)}}),this.node.stxtap(function(){var t=o.params.toggles,e=o.params.obj;if(1<t.length){for(var a=0;a<t.length;a++){var i=t[a];if(o.currentValue==i){a<t.length-1?o.set(t[a+1]):o.set(t[0]);break}}a==t.length&&o.set(t[0])}else o.currentValue?o.set(!1):o.set(!0);n.draw(),e===n.layout&&n.changeOccurred("layout")})},T.UI.Toggle=document.registerElement("cq-toggle",w);var U={prototype:Object.create(T.UI.ContextTag)};U.prototype.attachedCallback=function(){this.attached||(T.UI.ContextTag.attachedCallback.apply(this),this.node=$(this),this.params={toolSelection:this.node.find("*[cq-current-tool]"),lineSelection:this.node.find("*[cq-line-style]"),fontSizeSelection:this.node.find("*[cq-font-size]"),fontFamilySelection:this.node.find("*[cq-font-family]"),fontStyleToggle:this.node.find("cq-annotation-italic"),fontWeightToggle:this.node.find("cq-annotation-bold")},this.noToolSelectedText="",this.attached=!0)},U.prototype.defaultElements=function(t){var e=[];for(var a in t)"color"==a?e.push("cq-line-color"):"fillColor"==a?e.push("cq-fill-color"):"pattern"==a||"lineWidth"==a?e.push("cq-line-style"):"axisLabel"==a?e.push("cq-axis-label"):"font"==a?e.push("cq-annotation"):"parameters"==a&&e.push("cq-clickable");return e},U.prototype.setContext=function(t){this.noToolSelectedText=$(this.params.toolSelection).text(),this.sync()},U.prototype.sync=function(t){var e=this.context.stx;t?e.currentVectorParameters=t:t=e.currentVectorParameters,this.setLine(null,t.lineWidth,t.pattern);var a=e.canvasStyle("stx_annotation"),i=t.annotation.font.size||a.fontSize;this.setFontSize(null,i);var o=t.annotation.font.family||a.fontFamily;this.setFontFamily(null,o);var n=t.annotation.font.style||a.fontStyle;$(this.params.fontStyleToggle)["italic"===n?"addClass":"removeClass"]("ciq-active");var s=t.annotation.font.weight||a.fontWeight;$(this.params.fontWeightToggle)["bold"===s||700<=s?"addClass":"removeClass"]("ciq-active"),this.getFillColor({}),this.getLineColor({})},U.prototype.emit=function(){var t=document.createEvent("Event");t.initEvent("change",!0,!0),this.dispatchEvent(t)},U.prototype.noTool=function(){var t=this.context.stx;t.changeVectorType(null),t.layout.crosshair&&(t.layout.crosshair=!1,t.changeOccurred("layout"),t.doDisplayCrosshairs()),t.preferences.magnet&&this.toggleMagnet(this),$(this.params.toolSelection).text(this.noToolSelectedText),this.node.find("*[cq-section]").removeClass("ciq-active"),this.emit()},U.prototype.crosshairs=function(t){var e=this.context.stx;$(this.params.toolSelection).text(e.translateIf($(t.node).text())),e.changeVectorType(null),e.layout.crosshair=!0,e.doDisplayCrosshairs(),e.findHighlights(!1,!0),e.changeOccurred("layout"),e.draw(),e.updateChartAccessories(),this.node.find("*[cq-section]").removeClass("ciq-active"),this.emit()},U.prototype.toggleMagnet=function(t){var e=$(t.node),a=this.context.stx;a.preferences.magnet?(e.removeClass("active"),a.preferences.magnet=!1):(e.addClass("active"),a.preferences.magnet=!0),T.clearCanvas(a.chart.tempCanvas,a)},U.prototype.clearDrawings=function(){this.context.stx.clearDrawings()},U.prototype.tool=function(t,e){var a=this.context.stx;a.clearMeasure(),a.changeVectorType(e),$(this.params.toolSelection).text(a.translateIf($(t.node).text())),this.node.find("*[cq-section]").removeClass("ciq-active");var i=T.Drawing.getDrawingParameters(a,e);if(i){"fibtimezone"===e&&delete i.parameters;for(var o=this.defaultElements(i),n=0;n<o.length;n++)$(this.node).find(o[n]).addClass("ciq-active")}this.emit()},U.prototype.setLine=function(t,e,a){var i=this.context.stx;i.currentVectorParameters.lineWidth=e,i.currentVectorParameters.pattern=a,this.setFibs(e,a),this.currentLineSelectedClass&&$(this.params.lineSelection).removeClass(this.currentLineSelectedClass),this.currentLineSelectedClass="ciq-"+a+"-"+parseInt(e,10),"none"==a?this.currentLineSelectedClass=null:$(this.params.lineSelection).addClass(this.currentLineSelectedClass),this.emit()},U.prototype.setFibs=function(t,e){var a=this.context.stx.currentVectorParameters.fibonacci;if(a){for(var i=0;i<a.fibs.length;i++)a.fibs[i].parameters.lineWidth=t,a.fibs[i].parameters.pattern=e;a.timezone.parameters.lineWidth=t,a.timezone.parameters.pattern=e}},U.prototype.setFontSize=function(t,e){this.context.stx.currentVectorParameters.annotation.font.size=e,$(this.params.fontSizeSelection).text(e),this.emit()},U.prototype.setFontFamily=function(t,e){this.context.stx.currentVectorParameters.annotation.font.family="Default"==e?null:e,$(this.params.fontFamilySelection).text(e),this.emit()},U.prototype.toggleFontStyle=function(t,e){var a=this.context.stx;"italic"==e?"italic"==a.currentVectorParameters.annotation.font.style?(a.currentVectorParameters.annotation.font.style=null,$(t.node).removeClass("ciq-active")):(a.currentVectorParameters.annotation.font.style="italic",$(t.node).addClass("ciq-active")):"bold"==e&&("bold"==a.currentVectorParameters.annotation.font.weight?(a.currentVectorParameters.annotation.font.weight=null,$(t.node).removeClass("ciq-active")):(a.currentVectorParameters.annotation.font.weight="bold",$(t.node).addClass("ciq-active"))),this.emit()},U.prototype.toggleAxisLabel=function(t){var e=this.context.stx;!0===e.currentVectorParameters.axisLabel?(e.currentVectorParameters.axisLabel=!1,$(t.node).removeClass("ciq-active")):(e.currentVectorParameters.axisLabel=!0,$(t.node).addClass("ciq-active")),this.emit()},U.prototype.getFillColor=function(t){var e=t.node;e||(e=$(this).find("cq-fill-color"));var a=this.context.stx.currentVectorParameters.fillColor;$(e).css({"background-color":a})},U.prototype.pickFillColor=function(t){var e=t.node,a=$("cq-color-picker");if(a.length){var i=a[0],o=this;i.callback=function(t){o.context.stx.currentVectorParameters.fillColor=t,o.getFillColor({node:e}),o.emit()},i.display({node:e})}else console.log("DrawingToolbar.prototype.getFillColor: no ColorPicker available")},U.prototype.getLineColor=function(t){var e=t.node;e||(e=$(this).find("cq-line-color"));var a=this.context.stx.currentVectorParameters.currentColor;"transparent"!=a&&"auto"!=a||(a=""),$(e).css({"background-color":a})},U.prototype.pickLineColor=function(t){var e=t.node,a=$("cq-color-picker");if(a.length){var i=a[0],o=this;i.callback=function(t){o.context.stx.currentVectorParameters.currentColor=t,o.getLineColor({node:e}),o.emit()};var n=$(e).attr("cq-overrides");n&&(n=n.split(",")),i.display({node:e,overrides:n})}else console.log("DrawingToolbar.prototype.getFillColor: no ColorPicker available")},T.UI.DrawingToolbar=document.registerElement("cq-toolbar",U);var S={prototype:Object.create(T.UI.ContextTag)};S.prototype.attachedCallback=function(){this.attached||(T.UI.ContextTag.attachedCallback.apply(this),this.attached=!0)},S.prototype.initialize=function(t){this.params=t||{},this.params.viewObj||(this.params.viewObj={views:[]}),this.params.nameValueStore||(this.params.nameValueStore=new T.NameValueStore),this.params.template||(this.params.template="template[cq-view]"),this.params.template=this.node.find(this.params.template),this.params.template.detach();var a=this;this.params.nameValueStore.get("stx-views",function(t,e){!t&&e&&(a.params.viewObj.views=e),a.params.cb&&a.params.cb.call(a),a.renderMenu()})},S.prototype.renderMenu=function(){var t=$(this.node),i=this,o=i.context.stx;function e(a){return function(t){t.stopPropagation();var e=!1;$("cq-views").each(function(){this.params.viewObj.views.splice(a,1),e||(this.params.nameValueStore.set("stx-views",i.params.viewObj.views),e=!0),this.renderMenu()})}}function a(a){return function(t){t.stopPropagation(),i.uiManager.closeMenu(),i.context.loader&&i.context.loader.show();var e=T.first(i.params.viewObj.views[a]);setTimeout(function(){o.importLayout(i.params.viewObj.views[a][e],{managePeriodicity:!0,preserveTicksAndCandleWidth:!0,cb:function(){o.changeCallback&&o.changeCallback(o,"layout"),o.dispatch("layout",{stx:o}),i.context.loader&&i.context.loader.hide()}})},10)}}t.find("cq-views-content cq-item").remove();for(var n=0;n<this.params.viewObj.views.length;n++){var s=T.first(i.params.viewObj.views[n]);if("recent"!=s){var r=T.UI.makeFromTemplate(this.params.template),c=r.find("cq-label"),l=r.find("div");c.length&&(c.addClass("view-name-"+s),c.prepend(s)),l.length&&l.stxtap(e(n)),r.stxtap(a(n)),t.find("cq-views-content").append(r)}}var p=t.find("cq-view-save");if(p){var h=this.context;p.stxtap(function(t){$("cq-view-dialog").each(function(){$(this).find("input").val(""),this.open({context:h})})})}this.params.renderCB&&this.params.renderCB(t)},T.UI.Views=document.registerElement("cq-views",S);var M={};M.prototype=Object.create(T.UI.ContextTag),M.prototype.attachedCallback=function(){this.attached||(T.UI.ContextTag.attachedCallback.apply(this),this.attached=!0)},M.prototype.initialize=function(t){this.params=t||{},this.alwaysDisplayDialog=this.params.alwaysDisplayDialog||!1,this.excludedStudies=this.params.excludedStudies||[],this.params.template||(this.params.template="template"),this.params.template=this.node.find(this.params.template),this.params.template.detach(),this.renderMenu();var e=this;T.UI.observe({obj:T.Studies.studyLibrary,action:"callback",value:function(){e.renderMenu()}})},M.prototype.renderMenu=function(){var t,e=this.context.stx,a=[];for(var i in T.Studies.studyLibrary)!(t=T.Studies.studyLibrary[i])||this.excludedStudies[i]||this.excludedStudies[t.name]||(t.name||(t.name=i),a.push(i));a.sort(function(t,e){var a=T.Studies.studyLibrary[t],i=T.Studies.studyLibrary[e];return a.name<i.name?-1:a.name>i.name?1:0});for(var o=$(this.node),n=this,s=function(e,t){return function(t){!function(t,i){var e=n.context.stx;function a(t,e){if(!0===t)return p(e),!0;if("object"==typeof t)for(var a in t)if(a==i&&t[a])return p(e),!0}if(!a(n.params.dialogBeforeAddingStudy,{stx:e,name:i})){var o=T.Studies.addStudy(e,i);a(n.alwaysDisplayDialog,{sd:o,stx:e})}}(t.target,e),o.resize()}},r=o.find("cq-studies-content");0<r.length&&r[0].firstChild;)r[0].removeChild(r[0].firstChild);for(var c=0;c<a.length;c++){var l=T.UI.makeFromTemplate(this.params.template);t=T.Studies.studyLibrary[a[c]],l.append(T.translatableTextNode(e,t.name)),l.selectFC=s(a[c],this.context),l.stxtap(l.selectFC),o.find("cq-studies-content").append(l)}function p(t){t.context=n.context,$("cq-study-dialog").each(function(){this.open(t)})}},T.UI.StudyMenu=function(){throw new Error("The CIQ.UI.StudyMenu helper function has been replaced by a <cq-studies> webcomponent.")},T.UI.StudiesComponent=document.registerElement("cq-studies",M);var D={prototype:Object.create(HTMLElement.prototype)};D.prototype.createdCallback=function(){this.node=$(this),this.activeClassName="stxMenuActive",this.active=!1},D.prototype.attachedCallback=function(){if(!this.attached&&(this.uiManager=$("cq-ui-manager"),0<this.uiManager.length&&(this.uiManager=this.uiManager[0]),this.attached=!0,!this.node.attr("readonly"))){var e=this,t=this.node[0];this.node.stxtap(function(t){e.tap(t)}),t.addEventListener("stxtap",function(t){e.captureTap(t)},!0)}},D.prototype.open=function(t){this.uiManager.openMenu(this,t)},D.prototype.close=function(){this.uiManager.closeMenu(this)},D.prototype.lift=function(){for(var t=this.lifts=this.uiManager.findLifts(this),e=0;e<t.length;e++)this.uiManager.lift(t[e])},D.prototype.unlift=function(){var t=this.lifts;if(t){for(var e=0;e<t.length;e++)this.uiManager.restoreLift(t[e]);this.lifts=null}},D.prototype.show=function(t){this.active||(this.active=!0,this.node.addClass(this.activeClassName),this.lift(),this.node.find("cq-scroll").each(function(){this.resize()}))},D.prototype.hide=function(){this.active&&(this.unlift(),this.node.removeClass(this.activeClassName),this.active=!1,$(this).find("input").each(function(){this==document.activeElement&&this.blur()}))},D.prototype.captureTap=function(t){var e=$(t.target).parents().addBack();this.noClose=e.filter(function(){var t=$(this).attr("cq-no-close");return void 0!==t&&!1!==t}).length,this.noClose||(this.noClose=e.filter(function(){return $(this).is("cq-separator,cq-heading")}).length)},D.prototype.tap=function(t){var e=this.uiManager;if(this.active)t.stopPropagation(),this.noClose||e.closeMenu(this);else if(!this.active){if(t.stopPropagation(),$(t.target).parents("cq-menu-dropdown").length)return;for(var a=!1,i=this.node.parents("cq-menu,cq-dialog"),o=0;o<i.length;o++)i[o].active&&(a=!0);a||e.closeMenu(),this.open()}},T.UI.Menu=document.registerElement("cq-menu",D);var E={prototype:Object.create(T.UI.BaseComponent)};T.UI.addInheritance(E,T.UI.Scroll),E.prototype.createdCallback=function(){if(this.ownerDocument===document){var t=$(this);T.UI.BaseComponent.createdCallback.call(this),void 0===t.attr("cq-no-scroll")&&T.UI.Scroll.prototype.createdCallback.call(this)}},E.prototype.attachedCallback=function(){if(!this.attached){var t=$(this);this.noMaximize=!0,T.UI.BaseComponent.attachedCallback.call(this),this.attached=!1,void 0===t.attr("cq-no-scroll")&&T.UI.Scroll.prototype.attachedCallback.call(this),this.attached=!0}},T.UI.MenuDropDown=document.registerElement("cq-menu-dropdown",E);var j={prototype:Object.create(T.UI.ContextTag)};j.prototype.tap=function(t){var e=this.context;$("cq-share-dialog").each(function(){this.open({context:e})})},T.UI.ShareButton=document.registerElement("cq-share-button",j);var P={prototype:Object.create(T.UI.DialogContentTag)};P.prototype.setState=function(t){this.node.find("cq-share-create").css({display:"none"}),this.node.find("cq-share-generating").css({display:"none"}),this.node.find("cq-share-uploading").css({display:"none"}),this.node.find("cq-share-"+t).css({display:"inline-block"})},P.prototype.close=function(){$("cq-share-dialog .share-link-div").html(""),T.UI.DialogContentTag.close.apply(this)},P.prototype.share=function(){var r=this.context.stx,c=this;this.setState("generating"),$("cq-share-dialog .share-link-div").html(""),T.UI.bypassBindings=!0,T.Share.createImage(r,{hide:[".stx_chart_controls"]},function(t){T.UI.bypassBindings=!1;var e=T.uniqueID(),a="https://share.chartiq.com",i=r.getStartDateOffset(),o={layout:r.exportLayout(),drawings:r.exportDrawings(),xOffset:i,startDate:r.chart.dataSegment[i].Date,endDate:r.chart.dataSegment[r.chart.dataSegment.length-1].Date,id:e,symbol:r.chart.symbol},n=a+"/upload/"+e,s={id:e,image:t,config:o};c.setState("uploading"),T.Share.uploadImage(t,n,s,function(t,e){c.setState("create"),null!==t?T.alert("error: "+t):$("cq-share-dialog .share-link-div").html(a+e)})})},T.UI.ShareDialog=document.registerElement("cq-share-dialog",P);var O={prototype:Object.create(T.UI.DialogContentTag)};O.prototype.open=function(t){T.UI.DialogContentTag.open.apply(this,arguments);var a=this.context.stx,e=t.aggregationType,i={kagi:{title:"Set Reversal Percentage"},renko:{title:"Set Range"},linebreak:{title:"Set Price Lines"},rangebars:{title:"Set Range"},pandf:{title:"Set Point & Figure Parameters"}};a.layout.aggregationType!=e&&a.setAggregationType(e);var o=i[e],n=this.node;for(var s in n.find(".title").text(a.translateIf(o.title)),i)n.find(".ciq"+s).css(e===s?{display:""}:{display:"none"});n.find(".ciq"+e+" input").each(function(){var t=this.name;"box"!=t&&"reversal"!=t||(t="pandf."+t);var e=T.deriveFromObjectChain(a.layout,t);e&&!e.obj[e.member]&&a.chart.defaultChartStyleConfig[this.name]&&$(this).val(a.chart.defaultChartStyleConfig[this.name])})},T.UI.AggregationDialog=document.registerElement("cq-aggregation-dialog",O);var B={prototype:Object.create(T.UI.Dialog.prototype)};B.prototype.createdCallback=function(){T.UI.Dialog.prototype.createdCallback.apply(this),this.params={colorMap:[["#ffffff","#e1e1e1","#cccccc","#b7b7b7","#a0a0a5","#898989","#707070","#626262","#555555","#464646","#363636","#262626","#1d1d1d","#000000"],["#f4977c","#f7ac84","#fbc58d","#fff69e","#c4de9e","#85c99e","#7fcdc7","#75d0f4","#81a8d7","#8594c8","#8983bc","#a187bd","#bb8dbe","#f29bc1"],["#ef6c53","#f38d5b","#f8ae63","#fff371","#acd277","#43b77a","#2ebbb3","#00bff0","#4a8dc8","#5875b7","#625da6","#8561a7","#a665a7","#ee6fa9"],["#ea1d2c","#ee652e","#f4932f","#fff126","#8ec648","#00a553","#00a99c","#00afed","#0073ba","#0056a4","#323390","#66308f","#912a8e","#e9088c"],["#9b0b16","#9e4117","#a16118","#c6b920","#5a852d","#007238","#00746a","#0077a1","#004c7f","#003570","#1d1762","#441261","#62095f","#9c005d"],["#770001","#792e03","#7b4906","#817a0b","#41661e","#005827","#005951","#003b5c","#001d40","#000e35","#04002c","#19002b","#2c002a","#580028"]]}},B.prototype.attachedCallback=function(){if(!this.attached){T.UI.Dialog.prototype.attachedCallback.apply(this);var t=$(this),e=t.attr("cq-colors");if(e){e=e.split(",");var a=Math.ceil(Math.sqrt(e.length));this.params.colorMap=[],console.log("this.params.colorMap=[]"),console.log(typeof this.params.colorMap);for(var i=0,o=[],n=0;n<e.length;n++)a<=i&&(i=0,this.params.colorMap.push(o),o=[]),o.push(e[n]),i++;this.params.colorMap.push(o)}this.cqOverrides=t.find("cq-overrides"),this.template=this.cqOverrides.find("template"),this.initialize(),this.attached=!0}},B.prototype.setColors=function(t){this.params.colorMap=t,this.initialize()},B.prototype.initialize=function(){function t(t,e){return function(){t.pickColor(e)}}this.picker=$(this),this.colors=this.picker.find("cq-colors"),this.colors.length||(this.colors=this.picker),this.colors.empty();for(var e=0;e<this.params.colorMap.length;e++)for(var a=this.params.colorMap[e],i=$("<UL></UL>").appendTo(this.colors),o=0;o<a.length;o++){var n=$("<LI></LI>").appendTo(i),s=$("<SPAN></SPAN>").appendTo(n);s.css({"background-color":a[o]}),s.stxtap(t(this,a[o]))}},B.prototype.pickColor=function(t){this.callback&&this.callback(t),this.close()},B.prototype.resize=function(){},B.prototype.display=function(t){var e=$(t.node),a=e[0].getBoundingClientRect();this.picker.css({top:"0px",left:"0px"});var i=this.parentNode.getBoundingClientRect(),o=a.left-i.left+e.width()+10,n=a.top-i.top+5,s=$(document).width(),r=this.picker.width();s<o+r&&(o=s-r-20);var c=$(document).height(),l=this.picker.height();if(c<n+l&&(n=c-l-20),this.picker.css({left:o+"px",top:n+"px"}),this.cqOverrides.emptyExceptTemplate(),t.overrides&&this.template.length)for(var p=0;p<t.overrides.length;p++){var h=t.overrides[p],u=T.UI.makeFromTemplate(this.template,!0);u.text(h),u.stxtap(function(t,e){return function(){t.pickColor(e)}}(this,h))}this.picker.hasClass("stxMenuActive")?this.context.e&&this.context.e.stopPropagation():this.picker[0].open({context:T.UI.getMyContext(this)})},T.UI.ColorPicker=document.registerElement("cq-color-picker",B);var F={prototype:Object.create(T.UI.DialogContentTag)};F.prototype.setContext=function(t){T.UI.DialogContentTag.setContext.call(this,t),t.advertiseAs(this,"StudyDialog")},F.prototype.attachedCallback=function(){if(!this.attached){T.UI.DialogContentTag.attachedCallback.apply(this);var t=$(this);this.inputTemplate=t.find("template[cq-study-input]"),this.outputTemplate=t.find("template[cq-study-output]"),this.parameterTemplate=t.find("template[cq-study-parameters]"),this.attached=!0,this.queuedUpdates={}}},F.prototype.hide=function(){T.isEmpty(this.queuedUpdates)||(this.helper.updateStudy(this.queuedUpdates),this.queuedUpdates={}),this.node.find("cq-menu").each(function(){this.unlift&&this.unlift()}),this.node.find("cq-swatch").each(function(){this.colorPicker&&this.colorPicker.close()})},F.prototype.setChangeEvent=function(t,e,a){var i=this;t.change(function(){var t={};t[e]={},t[e][a]=this.value,"checkbox"!=this.type&&"radio"!=this.type||(t[e][a]=this.checked),i.updateStudy(t)})},F.prototype.updateStudy=function(t){$(this).find(":invalid").length||(this.helper.libraryEntry.deferUpdate?(T.extend(this.queuedUpdates,{inputs:t.inputs}),this.helper.updateStudy({outputs:t.outputs,parameters:t.parameters})):this.helper.updateStudy(t))},F.prototype.setSelectOption=function(t,e){var a=$(t.node),i=a.attr("name"),o=a.attr("value"),n=$(a[0].cqMenuWrapper);n.find("cq-selected").text(this.helper.stx.translateIf(o)),n[0].fieldValue=o,e||(e="inputs");var s={};s[e]={},s[e][i]=o,this.updateStudy(s)},F.prototype.setGenericParameters=function(t){t.parameters.yaxisDisplay=t.parameters.yaxisDisplayValue,this.hasAttribute("cq-study-panel")&&(t.parameters||(t.parameters={}),t.parameters.panelName="panel",t.parameters.underlayEnabled=!1),this.hasAttribute("cq-study-axis")&&(t.parameters||(t.parameters={}),t.parameters.yaxisDisplay=["right","left","none","shared"])},F.prototype.open=function(t){T.UI.DialogContentTag.open.apply(this,arguments),t&&t.sd&&this.setGenericParameters(t.sd),this.helper=new T.Studies.DialogHelper(t);var e=$(this);e.find(".title").text(this.helper.title);var a,c=this;function i(t,e,a,i){var o=T.UI.makeFromTemplate(c.menuTemplate),n=o.find("cq-menu-dropdown");for(var s in a){var r=$("<cq-item></cq-item>");r.text(a[s]),r.attr("stxtap","StudyDialog.setSelectOption('"+i+"')"),n.append(r),r[0].cqMenuWrapper=n.parents("cq-menu")[0],r.attr("name",t),r.attr("value",s),r[0].context=c.context}return o.find("cq-selected").text(c.helper.stx.translateIf(e)),o}var o,n=e.find("cq-study-inputs");for(var s in n.empty(),this.helper.inputs){var r=this.helper.inputs[s],l=T.UI.makeFromTemplate(this.inputTemplate,n);this.menuTemplate=l.find("template[cq-menu]"),l.find(".ciq-heading").text(r.heading),l[0].fieldName=r.name;var p,h=null;if(a=this.helper.attributes[r.name],"number"==r.type)for(p in(h=$("<input>")).attr("type","number"),h.val(r.value),this.setChangeEvent(h,"inputs",r.name),a){var u=a[p];(T.isIE||T.isEdge)&&"step"==p&&Math.floor(u)!=u&&(u="any"),h.attr(p,u)}else if("text"==r.type)for(p in(h=$("<input>")).attr("type","text"),h.val(r.value),this.setChangeEvent(h,"inputs",r.name),a)h.attr(p,a[p]);else if("select"==r.type)h=i(r.name,r.value,r.options,"inputs"),a&&a.readonly&&h.attr("readonly",a.readonly);else if("checkbox"==r.type)for(p in(h=$("<input>")).attr("type","checkbox"),r.value&&h.prop("checked",!0),this.setChangeEvent(h,"inputs",r.name),a)h.attr(p,a[p]);a&&a.hidden&&l.hide(),h&&l.find(".stx-data").append(h)}var d=e.find("cq-study-outputs");for(s in d.empty(),this.helper.outputs){var m=this.helper.outputs[s],f=T.UI.makeFromTemplate(this.outputTemplate,d);f[0].initialize({studyDialog:this,output:m.name,params:t}),f.find(".ciq-heading").text(m.heading),f.find(".ciq-heading")[0].fieldName=m.name,o=f.find("cq-swatch");var v=m.color;"object"==typeof v&&(v=v.color),o[0].setColor(v,!1)}var g=e.find("cq-study-parameters");for(s in g.empty(),this.helper.parameters){var y=this.helper.parameters[s],b=T.UI.makeFromTemplate(this.parameterTemplate,g);if(this.menuTemplate=b.find("template[cq-menu]"),this.menuTemplate.length||!y.options){b.find(".ciq-heading").text(y.heading),o=b.find("cq-swatch");var x,C=$("<input>");if(a={},y.defaultValue.constructor==Boolean)for(x in C.attr("type","checkbox"),y.value&&C.prop("checked",!0),this.setChangeEvent(C,"parameters",y.name+"Enabled"),o.remove(),a=this.helper.attributes[y.name+"Enabled"])C.attr(x,a[x]);else if(y.defaultValue.constructor==String){var q=y.name;for(x in y.defaultColor?(b[0].initialize({studyDialog:this,parameter:y.name+"Color",params:t}),o[0].setColor(y.color,!1),q+="Value"):o.remove(),y.options?C=i(q,y.value,y.options,"parameters"):C.val(y.value),a=this.helper.attributes[q])C.attr(x,a[x])}else{if(y.defaultValue.constructor!=Number)continue;for(x in C.attr("type","number"),C.val(y.value),this.setChangeEvent(C,"parameters",y.name+"Value"),b[0].initialize({studyDialog:this,parameter:y.name+"Color",params:t}),o[0].setColor(y.color,!1),a=this.helper.attributes[y.name+"Value"]){var k=a[x];(T.isIE||T.isEdge)&&"step"==x&&Math.floor(k)!=k&&(k="any"),C.attr(x,k)}}a&&a.hidden&&b.hide(),b.find(".stx-data").append(C)}else b.remove()}},T.UI.StudyDialog=document.registerElement("cq-study-dialog",F);var L={prototype:Object.create(T.UI.BaseComponent)};T.UI.StudyInput=document.registerElement("cq-study-input",L);var V={prototype:Object.create(T.UI.ModalTag)};V.prototype.setContext=function(t){this.template=this.node.find("template"),this.previousStudies={},this.begin()},V.prototype.begin=function(){var t=this;function e(){t.showHide(),t.renderLegend()}this.context.stx.addEventListener("layout",e),e()},V.prototype.showHide=function(){for(var t in this.context.stx.layout.studies)if(!this.context.stx.layout.studies[t].customLegend)return void this.node.css({display:""});this.node.css({display:"none"})},V.prototype.renderLegend=function(){var s=this.context.stx;if(s.layout.studies){this.previousStudies=T.shallowClone(s.layout.studies),$(this.template).parent().emptyExceptTemplate();var t=void 0!==this.node.attr("cq-overlays-only"),e=void 0!==this.node.attr("cq-panel-only"),a=void 0!==this.node.attr("cq-custom-removal-only"),i=this.node.parents(".stx-holder"),o=null,n=this.node.attr("cq-marker-label");for(var r in i.length&&(o=i.attr("cq-panel-name")),s.layout.studies){var c=s.layout.studies[r];if(!c.customLegend&&(!a||c.study.customRemoval)&&(!e||c.panel==o)&&(!t||c.overlay||c.underlay)){var l=T.UI.makeFromTemplate(this.template,!0);l.find("cq-label").html(c.inputs.display);var p=l.find(".ciq-close");c.permanent?p.hide():p.stxtap(u(this,c));var h=l.find(".ciq-edit");h.length||(h=l.find("cq-label")),h.stxtap(d(this,r))}}void 0!==n&&1<this.node[0].childElementCount&&this.node.prepend("<cq-marker-label>"+n+"</cq-marker-label>"),T.I18N.translateUI(null,this.node[0]),this.showHide()}function u(e,a){return function(t){setTimeout(function(){T.Studies.removeStudy(e.context.stx,a),e.node[0].hasAttribute("cq-marker")&&e.context.stx.modalEnd(),e.renderLegend()},0)}}function d(o,n){return function(t){var e=s.layout.studies[n];if(e.editFunction){t.stopPropagation(),o.uiManager.closeMenu();var a=o.context.getAdvertised("StudyEdit"),i={stx:s,sd:e,inputs:e.inputs,outputs:e.outputs,parameters:e.parameters};a.editPanel(i)}}}},T.UI.StudyLegend=document.registerElement("cq-study-legend",V);var A={prototype:Object.create(T.UI.BaseComponent)};A.prototype.initialize=function(t){this.params=t},A.prototype.setColor=function(t){if(this.params){var e={outputs:{}};e.outputs[this.params.output]={},e.outputs[this.params.output].color=t,this.params.studyDialog.updateStudy(e)}},T.UI.StudyOutput=document.registerElement("cq-study-output",A);var z={prototype:Object.create(T.UI.ContextTag)};return z.prototype.initialize=function(t){this.params=t},z.prototype.setColor=function(t){if(this.params){var e={parameters:{}};e.parameters[this.params.parameter]=t,this.params.studyDialog.updateStudy(e)}},T.UI.StudyParameter=document.registerElement("cq-study-parameter",z),t});